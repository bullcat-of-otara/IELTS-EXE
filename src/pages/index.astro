---
import Layout from '../layouts/Layout.astro';
import BandCalculator from '../components/BandCalculator.astro';
import SystemLog from '../components/SystemLog.astro';
import { getCollection } from 'astro:content';

const allWriting = await getCollection('writing');
---

<Layout title="IELTS.EXE | Dashboard">
  
  <!-- Section: HOME -->
  <div id="section-home" class="content-section p-8 md:p-12">
    <div class="max-w-7xl mx-auto flex flex-col items-center pt-20">
      <h1 class="text-7xl md:text-[10rem] font-bold tracking-tight mb-16 font-arcade uppercase text-transparent bg-clip-text bg-gradient-to-br from-neon-green to-neon-cyan drop-shadow-[0_0_25px_rgba(57,255,20,0.6)] leading-none">
        IELTS.EXE
      </h1>
      
      <!-- Dashboard Widgets Grid -->
      <div class="grid grid-cols-1 md:grid-cols-2 gap-8 w-full mb-16 px-4">
        <BandCalculator />
        <SystemLog />
      </div>

      <!-- Action Button (Navigates to Tab 2) -->
      <button 
        onclick="document.getElementById('tab-writing').click()"
        class="group relative inline-block px-12 py-6 text-3xl md:text-5xl font-arcade uppercase font-bold text-neon-green border-4 border-neon-green hover:bg-neon-green hover:text-black transition-all duration-100 shadow-[0_0_15px_#39ff14] hover:shadow-[0_0_40px_#39ff14] bg-black cursor-pointer-8bit"
      >
        PRESS START TO LEARN
      </button>
    </div>
  </div>

  <!-- Section: WRITING HUB -->
  <div id="section-writing" class="content-section hidden p-8 md:p-12">
     <div class="max-w-7xl mx-auto">
        <header class="mb-12 border-b-4 border-slate-800 pb-8">
            <h2 class="text-5xl md:text-7xl font-arcade text-white text-glow-indigo">
               WRITING HUB <span class="text-neon-green animate-blink">_</span>
            </h2>
            <p class="text-slate-400 font-arcade text-xl mt-2 uppercase tracking-wide">
                Select a module to begin training.
            </p>
        </header>

        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8">
          {allWriting.map((post) => {
            const wordCount = post.body ? post.body.split(/\s+/g).length : 0;
            const readingTime = Math.ceil(wordCount / 200);
            
            return (
              <article class="cursor-pointer-8bit group relative bg-slate-800/80 border-4 border-slate-700 hover:border-neon-green transition-all duration-100 cursor-pointer overflow-hidden hover:shadow-[0_0_20px_rgba(57,255,20,0.4)] hover:-translate-y-1">
                <!-- Top Bar -->
                <div class="bg-slate-900 border-b-4 border-slate-700 group-hover:border-neon-green px-4 py-2 flex justify-between items-center transition-colors">
                    <span class="text-slate-500 font-arcade text-sm uppercase group-hover:text-neon-green">Part 1</span>
                    <span class="inline-flex items-center gap-1 font-arcade text-neon-cyan text-sm">
                        <span class="w-2 h-2 bg-neon-cyan rounded-full animate-pulse"></span>
                        {readingTime}M READ
                    </span>
                </div>
                
                <div class="p-6">
                  <a href={`/writing/${post.slug}`} class="block">
                    <h3 class="text-2xl font-arcade font-bold mb-4 text-white group-hover:text-neon-green transition-colors leading-tight uppercase tracking-wide">
                      {post.data.title}
                    </h3>
                    {post.data.description && (
                      <p class="text-slate-400 font-sans text-sm line-clamp-3 leading-relaxed mb-6 border-l-2 border-slate-600 pl-3 group-hover:border-neon-green group-hover:text-slate-300 transition-colors">
                        {post.data.description}
                      </p>
                    )}
                  </a>
                  
                  <div class="flex items-center justify-between font-arcade text-lg mt-auto">
                     <span class="text-slate-600 group-hover:text-white transition-colors">STATUS: UNREAD</span>
                     <span class="bg-black text-neon-green border border-neon-green px-3 py-1 text-sm group-hover:bg-neon-green group-hover:text-black transition-colors">
                        OPEN &gt;
                     </span>
                  </div>
                </div>

                <!-- Corner Accent -->
                <div class="absolute bottom-0 right-0 w-4 h-4 bg-slate-700 group-hover:bg-neon-green transition-colors clip-path-polygon"></div>
              </article>
            );
          })}
        </div>
        
        {allWriting.length === 0 && (
          <div class="text-center text-slate-500 py-20 font-arcade text-3xl border-4 border-dashed border-slate-700">
            <p>NO DATA DISK INSERTED.</p>
          </div>
        )}
     </div>
  </div>
</Layout>

<script>
  // Inline script to handle tab switching logic since we want it to work immediately
  const tabs = document.querySelectorAll('.nav-tab');
  const sections = document.querySelectorAll('.content-section');

  tabs.forEach(tab => {
    tab.addEventListener('click', () => {
      // Deactivate all
      tabs.forEach(t => {
        t.classList.remove('bg-slate-800', 'text-neon-green', 'border-neon-green');
        t.classList.add('border-transparent');
        const arrow = t.querySelector('span:first-child');
        if(arrow) {
            arrow.classList.remove('opacity-100', 'animate-blink');
            arrow.classList.add('opacity-0');
        }
      });
      sections.forEach(s => s.classList.add('hidden'));

      // Activate clicked
      tab.classList.add('bg-slate-800', 'text-neon-green', 'border-neon-green');
      tab.classList.remove('border-transparent');
      const arrow = tab.querySelector('span:first-child');
      if(arrow) {
          arrow.classList.remove('opacity-0');
          arrow.classList.add('opacity-100', 'animate-blink');
      }
      
      const targetId = tab.id.replace('tab-', 'section-');
      const targetSection = document.getElementById(targetId);
      if (targetSection) {
        targetSection.classList.remove('hidden');
        window.scrollTo(0, 0); // Reset scroll for main window (but wait, overflow is on main)
        document.querySelector('main')?.scrollTo(0,0);
        
        // Glitch/Fade effect
        targetSection.animate([
           { opacity: 0, filter: 'blur(5px)' },
           { opacity: 1, filter: 'blur(0)' }
         ], {
           duration: 200,
           easing: 'steps(5)'
         });
      }
    });
  });

  // Default to Home on load
  document.getElementById('tab-home')?.click();
</script>

<style>
    .clip-path-polygon {
        clip-path: polygon(100% 0, 0% 100%, 100% 100%);
    }
    .typing-effect {
        /* Simple typing effect could be added here if desired */
    }
</style>
